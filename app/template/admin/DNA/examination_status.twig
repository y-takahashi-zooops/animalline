{#
This file is part of EC-CUBE

Copyright(c) EC-CUBE CO.,LTD. All Rights Reserved.

http://www.ec-cube.co.jp/

For the full copyright and license information, please view the LICENSE
file that was distributed with this source code.
#}
{% extends '@admin/default_frame.twig' %}

{% set menus = ['dna', 'dna_examination_status'] %}
{% set params = app.request.query.all %}

{% block title %}{{ '検査状況確認'|trans }}{% endblock %}
{% block sub_title %}{{ 'DNA検査'|trans }}{% endblock %}

{% block stylesheet %}
    <link rel="stylesheet" href="{{ asset('assets/css/tempusdominus-bootstrap-4.min.css', 'admin') }}">
{% endblock stylesheet %}

{% block main %}
    <div class="c-outsideBlock">
        <form id='search_form' method="get" action="">
            <div class="c-outsideBlock__contents">
                <div class="row justify-content-start">
                    <div class="col-6">
                        <div class="mb-2">
                            <label class="col-form-label" data-tooltip="true" data-placement="top"
                                   title="情報を入力して一覧の絞り込み検索ができます。">ブリーダーの名称・保護団体の名称
                                <i class="fa fa-question-circle fa-lg ml-1"></i></label>
                            <input type="text" name="customer_name" class="form-control"
                                   value="{{ params.customer_name is defined ? params.customer_name }}"/>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6">
                                <label class="col-form-label">種別</label>
                                <select id="pet_kind" name="pet_kind" class="form-control">
                                    {% set kindNames = ['全て', '犬', '猫'] %}
                                    {% for key, value in kindNames %}
                                        <option value="{{ key }}" {{ params.pet_kind is defined and params.pet_kind == key ? 'selected' }}>{{ value }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="mb-2">
                            <label class="col-form-label">検査状況</label>
                            <select class="ec-select form-control" name="check_status">
                                <option value="">選択してください</option>
                                {% set check_status = {1:'受付', 2:'出荷指示中', 3:'出荷済', 4:'DNAチェック中', 6:'検体異常', 7:'DNA検査中', 8:'検査通過', 9:'検査NG', 10:'検体再送付手続済'} %}
                                {% for key, value in check_status %}
                                    <option value="{{ key }}" {{ params.check_status is defined and params.check_status == key ? 'selected' }}>{{ value }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="c-outsideBlock__contents mb-5">
                <button class="btn btn-ec-conversion px-5" type="submit">検索</button>
                {% if(params.customer_name is defined or params.pet_kind is defined or params.check_status is defined) %}
                    <span class="font-weight-bold ml-2">検索結果：{{ dnas.count() }}件が該当しました</span>
                {% endif %}
            </div>
            {% if(params.check_status is defined and params.check_status ) %}
                <div class="c-outsideBlock__contents mb-5">
                    <ul class="list-inline">
                        <li class="list-inline-item">
                            <span class="font-weight-bold">検査状況:&nbsp;</span>{{ check_status[params.check_status] }}
                        </li>
                    </ul>
                </div>
            {% endif %}
        </form>
    </div>
    <div class="c-contentsArea__cols">
        <div class="c-contentsArea__primaryCol">
            <div class="c-primaryCol">
                <form id="form_bulk" method="post" action="">
                    <input type="hidden" name="dna-id" value="">
                    <input type="hidden" name="change-status-id" value="">
                    <div class="row justify-content-between mb-2">
                        <div class="col-6">
                            <div id="btn_bulk" class="d-none">
                                <label class="mr-2">一括操作</label>
                                <button class="btn btn-ec-regular mr-2 action-submit">検査キット再請求</button>
                            </div>
                        </div>
                        <div class="col-5 text-right">
                            <div class="d-inline-block mr-2">
                                <div>
                                    <select class="custom-select" onchange="location = this.value;">
                                        {% for i in range(10, 60, 10) %}
                                            <option value="{{ url('admin_dna_examination_status',
                                                params|merge({'item': i})) }}" {{ params.item is defined ?
                                            (params.item == i ? 'selected') : (i == 50 ? 'selected') }}>{{ i }}件
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card rounded border-0 mb-4 d-block">
                        <div class="card-body p-0">
                            <table class="table table-sm">
                                <thead>
                                <tr>
                                    <th class="border-top-0 pt-2 pb-2"></th>
                                    <th class="border-top-0 pt-2 pb-2">ID</th>
                                    <th class="border-top-0 pt-2 pb-2">画像</th>
                                    <th class="border-top-0 pt-2 pb-2">種別</th>
                                    <th class="border-top-0 pt-2 pb-2">犬種/猫種</th>
                                    <th class="border-top-0 pt-2 pb-2 text-nowrap">検査ステータス</th>
                                    <th class="border-top-0 pt-2 pb-2">キット出荷</th>
                                    <th class="border-top-0 pt-2 pb-2">キット返送</th>
                                    <th class="border-top-0 pt-2 pb-2">結果受信</th>
                                    <th class="border-top-0 pt-2 pb-2 pr-3" colspan="3"></th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for dna in dnas %}
                                    <tr>
                                        <td></td>
                                        <td class="align-middle">{{ dna.dna_id }}</td>
                                        <td class="align-middle">
                                            {% if dna.pet_id %}
                                                <a target="_blank" href="{{ url(dna.site_type == constant('Customize\\Config\\AnilineConf::ANILINE_SITE_TYPE_BREEDER') ? 'breeder_pet_detail' : 'adoption_pet_detail', {'id':dna.pet_id}) }}">
                                                    <img src="{{ '/' ~ constant('Customize\\Config\\AnilineConf::ANILINE_IMAGE_URL_BASE') ~ dna.thumbnail_path | default('/noimage_plugin_list.png') }}"
                                                        style="max-width: 50px">
                                                </a>
                                            {% else %}
                                                <img src="{{ '/' ~ constant('Customize\\Config\\AnilineConf::ANILINE_IMAGE_URL_BASE') ~ dna.thumbnail_path | default('/noimage_plugin_list.png') }}"
                                                    style="max-width: 50px">
                                            {% endif %}
                                        </td>
                                        <td class="align-middle">{{ dna.pet_kind == constant('Customize\\Config\\AnilineConf::ANILINE_PET_KIND_DOG') ? '犬' : '猫' }}</td>
                                        <td class="align-middle">{{ dna.breeds_name }}</td>
                                        <td class="align-middle">{{ check_status[dna.check_status] }}</td>
                                        <td class="align-middle">{{ dna.kit_shipping_date is empty ? '_' : dna.kit_shipping_date | date('Y/m/d H:i') }}</td>
                                        <td class="align-middle">{{ dna.kit_return_date is empty ? '_' : dna.kit_return_date | date('Y/m/d H:i') }}</td>
                                        <td class="align-middle">{{ dna.check_return_date is empty ? '_' : dna.check_return_date | date('Y/m/d H:i') }}</td>
                                        <td class="align-middle pr-3" colspan="3">
                                            <div class="text-right">
                                                <div class="px-1 d-inline-block text-center" data-tooltip="true"
                                                     data-placement="top" title="検査キット再送付">
                                                    <a class="btn btn-ec-actionIcon" {{ dna.check_status == constant('Customize\\Config\\AnilineConf::ANILINE_DNA_CHECK_STATUS_PASSED') ? 'onclick=change('~dna.dna_id~')' : 'disabled' }}>
                                                        <i class="fa fa-vial fa-lg text-secondary"
                                                           aria-hidden="true"></i>
                                                    </a>
                                                </div>
                                                <div class="px-1 d-inline-block text-center" data-tooltip="true"
                                                     data-placement="top" title="審査結果表示">
                                                    <a {% if (true) %} href="{{ url('admin_dna_download_pdf', {'id':dna.dna_id}) }}" {% else %} disabled {% endif %} class="btn btn-ec-actionIcon">
                                                        <i class="fa fa-files-o fa-lg text-secondary"
                                                           aria-hidden="true"></i>
                                                    </a>
                                                </div>
                                                <div class="px-1 d-inline-block text-center" data-tooltip="true"
                                                     data-placement="top" title="公開ステータス変更">
                                                    <a class="btn btn-ec-actionIcon" {{ dna.check_status == constant('Customize\\Config\\AnilineConf::ANILINE_DNA_CHECK_STATUS_PASSED') ? 'onclick=changeStatus('~dna.dna_id~')' : 'disabled' }}>
                                                        <i class="fa fa-eye fa-lg text-secondary"
                                                           aria-hidden="true"></i>
                                                    </a>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                {% else %}
                                    <tr>
                                        <td colspan="10">結果が０件です。</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="modal fade" id="confirm-modal-status" tabindex="-1" role="dialog"
                             aria-labelledby="confirm-modal" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title font-weight-bold">
                                            確認ダイアログ
                                        </h5>
                                        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">×</span>
                                        </button>
                                    </div>
                                    <div class="modal-body text-left">
                                        <p class="text-left modal-message">ペット情報を公開しますか？</p>
                                    </div>
                                    <div class="modal-footer">
                                        <button class="btn btn-ec-sub" type="button" data-dismiss="modal">
                                            いいえ
                                        </button>
                                        <button class="btn btn-ec-conversion" type="submit">
                                            はい
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal fade" id="confirm-modal" tabindex="-1" role="dialog"
                             aria-labelledby="confirm-modal" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title font-weight-bold">
                                            確認ダイアログ
                                        </h5>
                                        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">×</span>
                                        </button>
                                    </div>
                                    <div class="modal-body text-left">
                                        <p class="text-left modal-message">検体を再送付しますか？</p>
                                    </div>
                                    <div class="modal-footer">
                                        <button class="btn btn-ec-sub" type="button" data-dismiss="modal">
                                            {{ 'admin.common.cancel'|trans }}
                                        </button>
                                        <button class="btn btn-ec-conversion" type="submit">
                                            はい
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="navigation float-right">
                {{ knp_pagination_render(dnas) }}
            </div>
        </div>
    </div>
{% endblock %}
{% block javascript %}
<script src="//yubinbango.github.io/yubinbango/yubinbango.js" charset="UTF-8"></script>
<script>
    function change(id) {
    $('input[name=dna-id]').val(id);
    $('#confirm-modal').modal('show');
};
    function changeStatus(id) {
        console.log('1');
    $('input[name=change-status-id]').val(id);
    $('#confirm-modal-status').modal('show');
};
    $(".btn-ec-conversion").on('click', function() {
    setTimeout(function () {
        $('#confirm-modal').modal('hide');
    }, 2000);
});
</script>
{% endblock %}


