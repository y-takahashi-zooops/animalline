{% set site_type = 'breeder' %}
{% extends 'animalline/breeder/frame.twig' %}

{% block stylesheet %}
<!-- select2 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css"
    integrity="sha256-FdatTf20PQr/rWg+cAKfl6j4/IY3oohFAJ7gVC3M34E=" crossorigin="anonymous">
<!-- select2-bootstrap4-theme -->
<link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme/dist/select2-bootstrap4.min.css">
{% endblock %}

{% block main %}
    <section id="breeder-column" class="breeder-column_dog">
        <div class="inner">
            <div class="row mb-2">
                <div class="col-sm-3 col-6">
                    <a href={{ path('breeder_pet_list') }} class="btn btn-warning w-100 text-align-center my-1">
                        <i class="fas fa-arrow-left ml-1"></i>
                        ペット一覧                            
                    </a>
                </div>
            </div>
            <div class="breeder-column__main_section_title" style="text-align: center;">
                <h3>ペット情報編集</h3>
            </div>
            <div class="breeder-column__main_section_body">
                {{ include('animalline/breeder/member/pets/_form.twig', {'button_label': 'Update'}) }}
                <input hidden id="form-edit">
            </div>
        </div>
    </section>
{% endblock %}

{% block javascript %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script> {# current jquery slim not support ajax #}
<!-- select2 -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"
    integrity="sha256-AFAYEOkzB6iIKnTYZOdUf9FFje6lOTYdwRJKwTN5mks=" crossorigin="anonymous"></script>
<script src="{{ asset('assets/js/breeder_pets.js') }}"></script>
<script>
    var subSrc = '{{ constant("Customize\\Config\\AnilineConf::ANILINE_IMAGE_URL_BASE") }}';
    var thumbnailPath = `{{ thumbnailPath }}`;
    var petImages = {{ pet_mages | json_encode | raw }};
    let disabledFlag = true;
    $(document).ready(function() {
        $("#breeder_pets_breeds_type").select2({
            theme: 'bootstrap4',
            language: {
                "noResults": function () {
                    return "結果が見つかりません。";
                }
            }
        });

        if (thumbnailPath !== '' && thumbnailPath !== null && thumbnailPath !== undefined) {

            const $input = $('#breeder_pets_thumbnail_path');
            const $box   = $input.closest('.preview_box');

            // input 非表示
            $input.hide();

            // ✅ 正しい img 取得ルート
            $box.find('.img_preview')
                .attr('src', thumbnailPath)
                .removeClass('d-none')
                .show();

            // 削除ボタン表示
            $box.closest('.images').find('button.btn_remove').show();

            // hidden input に値セット
            $(`input.breeder_pets_thumbnail_path`).val(thumbnailPath);

            disabledFlag = false;
        }
        if (`{{ image0 }}`) {
            disabledFlag = false;
        }
        petImages.forEach((p) => {
            setImageToBox(p.image_uri, p.sort_order - 1)
        });
    });
    var inputImageId = '';
    var modalEl = document.getElementById('modal');
    var bs_modal = new bootstrap.Modal(modalEl);
    var image = document.getElementById('image');
    var cropper, reader, file, size;

    function setImageToBox(image, key) {
        const id = 'breeder_pets_image' + key;

        const $input = $(`#${id}`);
        const $box   = $input.closest('.preview_box');
        const $images = $box.closest('.images');

        $input.prop('disabled', disabledFlag);

        if (image && image.length > 0) {

            // input 非表示
            $input.hide();

            // 正しい preview 取得
            $box.find('.img_preview')
                .attr('src', image)
                .removeClass('d-none')
                .show();

            // 削除・メイン画像ボタン表示
            $images.find('button').show();

            // hidden input に値セット
            $(`input.${id}`).val(image);

            disabledFlag = false;
        }
    }

    $("input[type='file']").change(function (e) {
        inputImageId = e.target.id;
        var files = e.target.files;

        var done = function (url) {
            var files = e.target.files;

            var fileReader = new FileReader();

            fileReader.onload = function(event) {
                $.ajax({
                    url:'/ajax/imageconvert',
                    type:'POST',
                    dataType: 'json',
                    data: {
                        'filename': file.name,
                        'filedata': event.target.result,
                    },
                })
                .done( (data) => {
                    image.src = data.url;
                    bs_modal.show();
                })
                .fail( (jqXHR, textStatus, errorThrown) => {
                    alert('ファイルのアップロードに失敗しました。');
                });
            }

            fileReader.readAsDataURL(file);
        }

        if (files && files.length > 0) {
            file = files[0];

            if (URL) {
                done(URL.createObjectURL(file));
            } else if (FileReader) {
                reader = new FileReader();
                reader.onload = function (e) {
                    done(reader.result);
                };
                reader.readAsDataURL(file);
            }
        }
    });
    
    modalEl.addEventListener('shown.bs.modal', function () {
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        
        cropper = new Cropper(image, {
            aspectRatio: 1,
            viewMode: 2,
            preview: '.preview',
            dragMode: 'none',
            autoCropArea: 1
        });
    });

    modalEl.addEventListener('hidden.bs.modal', function () {
        cropper.destroy();
        cropper = null;
        $(`#${ inputImageId }`).val('');
    });

    $("#crop").click(function () {
        size = cropper.imageData.naturalHeight < cropper.imageData.naturalWidth ? cropper.imageData.naturalHeight : cropper.imageData.naturalWidth;
        size = size < 1000 ? size : 1000;
        canvas = cropper.getCroppedCanvas({
            width: size,
            height: size,
        });

        // inputImageId は 'breeder_pets_thumbnail_path' など
        function showFileInputAndPreview(inputImageId, imageUrl) {
            const $input = $(`#${inputImageId}`);
            const $previewBox = $input.closest('.preview_box');
            const $imagesDiv = $previewBox.closest('.images');

            // input[type="file"] を表示
            $input.removeClass('d-none');

            // プレビュー画像を更新
            $previewBox.find('.img_preview').attr('src', imageUrl).removeClass('d-none').show();

            // 削除ボタンを表示
            $imagesDiv.find('button.btn_remove').show();

            // サムネ以外なら「メイン画像に設定」ボタンも表示
            if (inputImageId !== 'breeder_pets_thumbnail_path') {
                $imagesDiv.find('button.btn_set_thumbnail').show();
            }

            // hidden input に値をセット（サーバに送る用）
            $(`input.${inputImageId}`).val(imageUrl);
        }

        // Ajax でアップロード後に呼び出す
        canvas.toBlob(function(blob) {
            const url = URL.createObjectURL(blob);
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = function() {
                const base64data = reader.result;
                $.ajax({
                    type: "POST",
                    dataType: "json",
                    url: "/breeder/configration/pets/upload",
                    data: { image: base64data },
                    success: function(data) {
                        bs_modal.hide();
                        showFileInputAndPreview(inputImageId, '/' + data);
                    }
                });
            };
        });
    });

    $(document).on('click', '.btn_remove', function(e) {
        e.preventDefault();
        var inputFileIds = [];
        $("[type='file']").each(function(){
            inputFileIds.push($(this).attr("id"));
        });
        const index = inputFileIds.findIndex(p => p === e.target.classList[1]);
        const sortArr = inputFileIds.slice(index + 1);
        const imageArr = [];
        sortArr.forEach((p) => {
            const src = $(`input#${p}`).parent().find('.img_preview').attr('src');
            if (src) {
                imageArr.push({
                    class: p,
                    src: $(`input#${p}`).parent().find('.img_preview').attr('src')
                });
            } else {
                return ;
            }
        });
        if (imageArr.length === 0) {
            $(this).hide();
            $(this).parent().find('.btn_set_thumbnail').hide();
            $(this).parent().parent().find('.img_preview').hide();
            $(this).parent().parent().find('.img_preview').attr('src', '');
            $(this).parent().parent().find('.img_preview').addClass('d-none');
            $(this).parent().parent().find('.form-control-file').show();
            $(`input.${ e.target.classList[1] }`).val('');

            $(this).parent().parent().next().find("input[type='file']").attr('disabled', true);
        } else {
            imageArr.forEach((p) => {
                $(`#${ p.class }`).parent().parent().prev().find(".img_preview").attr('src', p.src);
                const inputClass = $(`#${ p.class }`).parent().parent().prev().find("input[type='file']").attr('id');
                $(`input.${ inputClass }`).val(p.src);
            });
            lastItem = imageArr.pop();
            $(`#${ lastItem.class }`).show();
            $(`#${ lastItem.class }`).parent().find(".img_preview").attr('src', '');
            $(`#${ lastItem.class }`).parent().find(".img_preview").addClass('d-none');
            $(`#${ lastItem.class }`).parent().parent().find("button").hide();
             $(`input.${ lastItem.class }`).val('');
            if (lastItem.class !== inputFileIds.pop()) {
                $(`#${ lastItem.class }`).parent().parent().next().find("input[type='file']").attr('disabled', true);
            }
        }
    });

    $(document).on('click', '.btn_set_thumbnail', function(e) {
        e.preventDefault();
        const currentId = e.target.classList[1];
        const currentSrc = $(this).parent().parent().find('.img_preview').attr('src');
        const thumbnailSrc  = $('#img_thumbnail').attr('src');
        $(this).parent().parent().find('.img_preview').attr('src', thumbnailSrc);
        $(`input.${ e.target.classList[1] }`).val(thumbnailSrc);

        $('#img_thumbnail').attr('src', currentSrc);
        $(`input.breeder_pets_thumbnail_path`).val(currentSrc);
    });
</script>
{% endblock %}
