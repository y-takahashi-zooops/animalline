{% set site_type = 'breeder' %}
{% extends 'ani_frame.twig' %}
{% block main %}
    <h1>新規ペット追加</h1>
    <br>
    <a href="{{ path('breeder_pet_list') }}">
       <img src="{{ asset('assets/img/arrow-icon.svg') }}" style="transform:rotate(-180deg);">
        <span>一覧へ戻る</span>
    </a>
    <hr>
    {{ include('animalline/breeder/member/pets/_form.twig') }}
{% endblock %}

{% block javascript %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script> {# current jquery slim not support ajax #}
<script src="{{ asset('assets/js/breeder_pets.js') }}"></script>
<script>
    $("[type='file']").each(function(){
        if ($(this).attr("id") !== 'breeder_pets_thumbnail_path') {
            $(this).attr('disabled', true);
        }
    });
    var inputImageId = '';
    var bs_modal = $('#modal');
    var image = document.getElementById('image');
    var cropper, reader, file, size;
    $(".form-control-file").change(function (e) {
        inputImageId = e.target.id;
        var files = e.target.files;
        var done = function (url) {
            image.src = url;
            bs_modal.modal('show');
        };

        if (files && files.length > 0) {
            file = files[0];

            if (URL) {
                done(URL.createObjectURL(file));
            } else if (FileReader) {
                reader = new FileReader();
                reader.onload = function (e) {
                    done(reader.result);
                };
                reader.readAsDataURL(file);
            }
        }
    });

    bs_modal.on('shown.bs.modal', function () {
        cropper = new Cropper(image, {
            aspectRatio: 1,
            viewMode: 2,
            preview: '.preview',
            dragMode: 'none',
            background: false,
        });
    }).on('hidden.bs.modal', function () {
        cropper.destroy();
        cropper = null;
        $(`#${ inputImageId }`).val('');
    });

    $("#crop").click(function () {
        size = cropper.imageData.naturalHeight < cropper.imageData.naturalWidth ? cropper.imageData.naturalHeight : cropper.imageData.naturalWidth;
        size = size < 1000 ? size : 1000;
        canvas = cropper.getCroppedCanvas({
            width: size,
            height: size,
        });

        canvas.toBlob(function (blob) {
            url = URL.createObjectURL(blob);
            var reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = function () {
                var base64data = reader.result;
                $.ajax({
                    type: "POST",
                    dataType: "json",
                    url: "/breeder/configration/pets/upload",
                    data: {image: base64data},
                    success: function (data) {
                        bs_modal.modal('hide');
                        $(`#${ inputImageId }`).parent().parent().next().find("input[type='file']").attr('disabled', false);
                        $(`#${ inputImageId }`).hide();
                        $(`#${ inputImageId }`).parent().find('.img_preview').attr('src', '/' + data)
                        $(`#${ inputImageId }`).parent().find('.img_preview').show();
                        $(`#${ inputImageId }`).parent().parent().find('button').show();
                        $(`input.${ inputImageId }`).val('/' + data);
                    }
                });
            };
        });
    });

    $(document).on('click', '.btn_remove', function(e) {
        e.preventDefault();
        var inputFileIds = [];
        $("[type='file']").each(function(){
            inputFileIds.push($(this).attr("id"));
        });
        const index = inputFileIds.findIndex(p => p === e.target.classList[1]);
        const sortArr = inputFileIds.slice(index + 1);
        const imageArr = [];
        sortArr.forEach((p) => {
            const src = $(`input#${p}`).parent().find('.img_preview').attr('src');
            if (src) {
                imageArr.push({
                    class: p,
                    src: $(`input#${p}`).parent().find('.img_preview').attr('src')
                });
            } else {
                return ;
            }
        });
        if (imageArr.length === 0) {
            $(this).hide();
            $(this).parent().find('.btn_set_thumbnail').hide();
            $(this).parent().parent().find('.img_preview').hide();
            $(this).parent().parent().find('.img_preview').attr('src', '');
            $(this).parent().parent().find('.form-control-file').show();
            $(`input.${ e.target.classList[1] }`).val('');

            $(this).parent().parent().next().find("input[type='file']").attr('disabled', true);
        } else {
            imageArr.forEach((p) => {
                $(`#${ p.class }`).parent().parent().prev().find(".img_preview").attr('src', p.src);
                const inputClass = $(`#${ p.class }`).parent().parent().prev().find("input[type='file']").attr('id');
                $(`input.${ inputClass }`).val(p.src);
            });
            lastItem = imageArr.pop();
            $(`#${ lastItem.class }`).show();
            $(`#${ lastItem.class }`).parent().find(".img_preview").attr('src', '');
            $(`#${ lastItem.class }`).parent().parent().find("button").hide();
             $(`input.${ lastItem.class }`).val('');
            if (lastItem.class !== inputFileIds.pop()) {
                $(`#${ lastItem.class }`).parent().parent().next().find("input[type='file']").attr('disabled', true);
            }
        }
    });

    $(document).on('click', '.btn_set_thumbnail', function(e) {
        e.preventDefault();
        const currentId = e.target.classList[1];
        const currentSrc = $(this).parent().parent().find('.img_preview').attr('src');
        const thumbnailSrc  = $('#img_thumbnail').attr('src');
        $(this).parent().parent().find('.img_preview').attr('src', thumbnailSrc);
        $(`input.${ e.target.classList[1] }`).val(thumbnailSrc);

        $('#img_thumbnail').attr('src', currentSrc);
        $(`input.breeder_pets_thumbnail_path`).val(currentSrc);
    });
</script>
{% endblock %}